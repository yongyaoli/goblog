{{ define "admin/attachments.html" }}
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>资源管理</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="/static/css/admin.css">
<link rel="stylesheet" href="/static/iconfont/iconfont.css">
</head>
<body>
{{ template "admin/navbar" . }}
 <main class="container py-4">
   <h3>资源管理</h3>
   <table class="table">
     <thead><tr><th>预览</th><th>文件名</th><th>类型</th><th>URL</th><th>大小</th><th>时间</th><th>操作</th></tr></thead>
     <tbody id="list"></tbody>
   </table>
   <nav aria-label="分页" class="mt-3"><ul class="pagination" id="pager"></ul></nav>
 </main>
 <script>
 ;(function(){
   const btn = document.getElementById('logoutBtn');
   if(btn){
     btn.onclick = async function(){
       const token = localStorage.getItem('token');
       try{
         await fetch('/api/admin/logout', {method:'POST', headers: token ? {Authorization:'Bearer '+token} : {}});
       }catch(e){}
       localStorage.removeItem('token');
       location.href = '/admin';
     };
   }
 })();
 const token = localStorage.getItem('token');
 const qs = new URLSearchParams(location.search);
 const page = parseInt(qs.get('page')||'1');
 const size = parseInt(qs.get('size')||'20');
 async function load(){
   const res = await fetch('/api/admin/attachments?page='+page+'&size='+size, {headers:{Authorization:'Bearer '+token}});
   const data = await res.json();
   const tbody = document.getElementById('list');
   tbody.innerHTML = '';
   for(const it of data.items||[]){
     const tr = document.createElement('tr');
     let preview = '';
     if(it.Type === 'image'){
       preview = `<img src="${it.URL}" style="height:48px">`;
     }else if(it.Type === 'video'){
       preview = `<i class="bi bi-file-play"></i>`;
     }else{
       preview = `<i class="bi bi-file-earmark"></i>`;
     }
     tr.innerHTML = `<td>${preview}</td><td>${it.FileName}</td><td>${it.Type}</td><td><a href="${it.URL}" target="_blank">${it.URL}</a></td><td>${fmtSize(it.SizeBytes)}</td><td>${new Date(it.CreatedAt).toLocaleString()}</td><td><button class="btn btn-sm btn-outline-danger" data-del="${it.ID}">删除</button></td>`;
     tbody.appendChild(tr);
   }
   buildPager(data.page, data.pages, size);
 }
 function fmtSize(n){
   if(!n) return '';
   if(n<1024) return n+'B';
   if(n<1024*1024) return (n/1024).toFixed(1)+'KB';
   if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+'MB';
   return (n/1024/1024/1024).toFixed(1)+'GB';
 }
 document.addEventListener('click', async (e)=>{
   const id = e.target && e.target.dataset && e.target.dataset.del;
   if(id){
     if(!confirm('确认删除该资源？')) return;
     const res = await fetch('/api/admin/attachments/'+id, {method:'DELETE', headers:{Authorization:'Bearer '+token}});
     if(res.ok){ load(); } else { alert('删除失败'); }
   }
 });
 load();
 function buildPager(page, pages, size){
   const el = document.getElementById('pager');
   const prev = Math.max(1, page-1), next = Math.min(pages, page+1);
   el.innerHTML = `
     <li class="page-item ${page<=1?'disabled':''}"><a class="page-link" href="?page=${prev}&size=${size}">上一页</a></li>
     <li class="page-item disabled"><span class="page-link">第 ${page} 页 / 共 ${pages} 页</span></li>
     <li class="page-item ${page>=pages?'disabled':''}"><a class="page-link" href="?page=${next}&size=${size}">下一页</a></li>
   `;
 }
 </script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
 </body>
 </html>
{{ end }}
